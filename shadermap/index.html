<!DOCTYPE html>
<html>
<head>
  <title>Shadermap</title>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel='stylesheet' href="https://unpkg.com/mapbox-gl@2.11.1/dist/mapbox-gl.css" />

  <meta property="description" content="Mapbox + a customizable post-processing shader">

  <meta property="og:type" content="article">
  <meta property="og:image" content="https://raw.githubusercontent.com/rreusser/maps/main/shadermap/thumbnail.jpg">
  <meta property="og:title" content="Shadermap">
  <meta property="og:description" content="Mapbox + a customizable post-processing shader">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Shadermap">
  <meta name="twitter:description" content="Mapbox + a customizable post-processing shader">
  <meta name="twitter:creator" content="rickyreusser">
  <meta name="twitter:image:src" content="https://raw.githubusercontent.com/rreusser/maps/main/shadermap/thumbnail.jpg">

  <style>
    #map {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .dg.ac {
      z-index: 2 !important;
    }
    #shader-editor {
      position: fixed;
      z-index: 2;
      width: 100%;
      bottom: 0;
      overflow-y: scroll;
      height: 25vh;
      left: 0;
      display: none;
    }
  </style>
</head>

<body>
<div id='map'></div>
<textarea id="shader-editor"></textarea>

<script src="https://unpkg.com/dat.gui@0.7.9/build/dat.gui.js"></script>
<script src="https://unpkg.com/mapbox-gl@2.11.1/dist/mapbox-gl.js"></script>
<script src="https://unpkg.com/regl@2.1.0"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicnJldXNzZXIiLCJhIjoiY2w5a3ZvcHU3NTJvZDNvcW1hcHAzeXB6cCJ9.CDFj_g1W8pBg6KA-ascYig';

const guiParams = new function () {
  this.projection = 'mercator';
  this.style = 'mapbox/satellite-v9';

  this['Toggle shader editor'] = toggleEdit;
  this['Download PNG'] = function downloadPng () {
    map.once("render", function () {
      var link = document.createElement("a");
      link.target = '_blank';
      link.download = "map.png";
      link.href = regl._gl.canvas.toDataURL();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    map.triggerRepaint();
  }
};

var map = window.map = new mapboxgl.Map({
  container: 'map',
  zoom: 1,
  center: [0, 10],
  style: `mapbox://styles/${guiParams.style}`,
  projection: guiParams.projection,
  hash: true,
  maxPitch: 0
});

class ShaderPostProcControl {
  constructor () {
    this.onResize = this.onResize.bind(this);

    this.frag = `precision lowp float;
    varying vec2 uv;
    uniform vec2 resolution;
    uniform sampler2D map;

    const float twoPi = 2.0 * ${Math.PI};
    const float facets = 5.0;

    void main () {
      vec2 xy = (uv - 0.5) * resolution;
      float theta = (abs(fract((atan(xy.y, xy.x) / twoPi) * facets) - 0.5) + 0.5) * twoPi / facets;
      vec2 samplePos = (vec2(cos(theta), sin(theta)) * length(xy)) / resolution + 0.5;
      vec2 mirrored = 1.0 - 2.0 * abs(fract(samplePos * 0.5) - 0.5);
      gl_FragColor = vec4(texture2D(map, mirrored).rgb, 1);
    }`;
  }

  onAdd(map) {
    const container = map.getContainer();
    this.canvas = document.createElement('canvas');
    this.canvas.style.position = 'absolute';
    this.canvas.style.top = 0;
    this.canvas.style.right = 0;
    this.onResize();
    window.addEventListener('resize', this.onResize);

    this.regl = createREGL({
      extensions: ['oes_standard_derivatives'],
      attributes: { preserveDrawingBuffer: true, antialias: true, depthStencil: false, alpha: false },
      canvas: this.canvas,
    });

    this.draw = this.regl({
      vert: `
        precision lowp float;
        attribute vec2 xy;
        varying vec2 uv;
        void main () {
          uv = 0.5 + 0.5 * xy;
          gl_Position = vec4(xy, 0, 1);
        }`,
      frag: this.regl.prop('frag'),
      attributes: {
        xy: [-4, -4, 4, -4, 0, 4]
      },
      uniforms: {
        resolution: (ctx) => [ctx.framebufferWidth, ctx.framebufferHeight],
        map: this.regl.prop("tex")
      },
      count: 3,
      depth: {enable: false}
    });

    const mapCanvas = map.getCanvas();
    const texParams = { flipY: true, min: 'linear', mag: 'linear' };
    const tex = this.regl.texture({ data: mapCanvas, ...texParams });

    map.on('render', () => {
      if (mapCanvas.width === tex.width && mapCanvas.height === tex.height) {
        tex.subimage(mapCanvas);
      } else {
        tex({ data: mapCanvas, ...texParams });
      }
      this.regl.poll();
      this.draw({tex, frag: editor.value});
    });

    map.triggerRepaint();

    return this.canvas;
  }

  onRemove () {
    window.removeEventListener('resize', this.onResize);
    this.regl.destroy();
    this.regl = null;
  }

  onResize () {
    this.canvas.width = map.getCanvas().width;
    this.canvas.height = map.getCanvas().height;
    this.canvas.style.width = `${map.getContainer().offsetWidth}px`;
    this.canvas.style.height = `${map.getContainer().offsetHeight}px`;
  }
}

function toggleEdit () {
  editor.style.display = editor.style.display === 'block' ? 'none' : 'block';
  editor.addEventListener('input', function (event) {
    event.stopPropagation();
    map.triggerRepaint();
  });
}

const postProc = new ShaderPostProcControl()
const editor = document.getElementById('shader-editor');
editor.textContent = postProc.frag;

map.on('load', function () {
  const gui = new dat.GUI();

  const style = gui.add(guiParams, 'style', [
    'mapbox/streets-v12',
    'mapbox/satellite-streets-v11',
    'mapbox/light-v10',
    'mapbox/dark-v10',
    'mapbox/outdoors-v11',
    'mapbox/satellite-v9',
  ]);
  style.onFinishChange(value => map.setStyle(`mapbox://styles/${value}`));
  const proj = gui.add(guiParams, 'projection', [
    'mercator',
    'globe',
    'naturalEarth',
    'equalArea',
  ]);
  proj.onFinishChange(value => map.setProjection(value));
  gui.add(guiParams, 'Toggle shader editor');
  gui.add(guiParams, 'Download PNG');

  map.addControl(postProc);
});

</script>
</body>
</html>
